<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>æ¥å®¢PDCA</title>
<style>
body {font-family: system-ui, sans-serif; margin:0; background:#fff; color:#111;}
header {padding:10px; border-bottom:1px solid #ddd; font-weight:bold;}
main {display:grid; grid-template-columns:380px 1fr; gap:12px; padding:12px;}
 @media(max-width:980px){main{grid-template-columns:1fr;}}
.panel{border:1px solid #ddd; border-radius:8px; padding:10px; background:#fff;}
.panel h3{margin:0 0 8px; font-size:1rem;}
textarea{width:100%; min-height:100px; margin-bottom:8px; padding:6px;}
select,input{width:100%; margin-bottom:6px; padding:6px;}
button{padding:6px 10px; margin:4px 0; border-radius:6px; cursor:pointer;}
.score{font-size:.9rem; margin:6px 0; padding:6px; border:1px solid #eee; border-radius:6px;}
.ok{color:green; font-weight:bold;}
.bad{color:#111;}
.na{color:#666;}
.item-row{display:flex; align-items:center; gap:6px; margin:2px 0;}
.item-row span.state{cursor:pointer; font-weight:bold; width:2em; text-align:center;}
.details{margin-top:4px; font-size:.85rem;}
table{width:100%; border-collapse:collapse; margin-top:8px; font-size:.9rem;}
th,td{border:1px solid #ddd; padding:6px;}
.section-label { 
  display: block; 
  font-weight: bold; 
  font-size: 1.1rem; 
  margin-top: 16px;
  margin-bottom: 4px;
  padding-bottom: 6px;
  border-bottom: 2px solid #eee;
}
#log {
  font-size: .9rem;  /* ãƒªã‚¹ãƒˆã¨åŒã˜å¤§ãã•ã« */
}

#log h4 {
  font-size: .9rem;  /* æ—¥ä»˜è¦‹å‡ºã—ã‚‚åŒã˜ã«æƒãˆã‚‹ */
}
#analysis {
  font-size: .9rem;  /* ãƒªã‚¹ãƒˆãƒ»ãƒ­ã‚°ã¨åŒã˜ */
  line-height: 1.4;
}
</style>
</head>
<body>
<header>æ¥å®¢PDCA</header>
<main>
<section class="panel">
  <h3>æ–°è¦å…¥åŠ›</h3>
  <label>æ—¥ä»˜</label><input type="date" id="f_date">

  <label>çµæœ</label>
  <select id="f_result">
    <option value="">é¸æŠ</option>
    <option>è³¼å…¥</option>
    <option>è³¼å…¥ãªã—</option>
    <option>ãƒ—ãƒ­ã‚¹ãƒšã‚¯ãƒˆ</option>
  </select>

  <label>æ¥åº—ç›®çš„</label>
  <select id="f_purpose">
    <option value="">é¸æŠ</option>
    <option>ã‚®ãƒ•ãƒˆ</option>
    <option>è‡ªåˆ†ç”¨</option>
    <option>ä¸‹è¦‹</option>
  </select>

  <label>ã‚«ãƒ†ã‚´ãƒª</label>
  <select id="f_category">
    <option value="">é¸æŠ</option>
    <option>ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼</option>
    <option>SLGï¼ˆå°ç‰©ï¼‰</option>
    <option>ãƒãƒƒã‚°</option>
    <option>ãƒ™ãƒ«ãƒˆ</option>
    <option>ã‚·ãƒ¥ãƒ¼ã‚º</option>
    <option>RTW</option>
  </select>

  <label>ä¾¡æ ¼å¸¯</label>
  <select id="f_price">
    <option value="">é¸æŠ</option>
    <option>ã€œ10ä¸‡å††</option>
    <option>10ã€œ20ä¸‡å††</option>
    <option>20ã€œ30ä¸‡å††</option>
    <option>30ã€œ50ä¸‡å††</option>
    <option>50ä¸‡å††ã€œ</option>
  </select>

  <label>å¹´ä»£</label>
  <select id="f_age">
    <option value="">é¸æŠ</option>
    <option>10ä»£</option><option>20ä»£</option><option>30ä»£</option>
    <option>40ä»£</option><option>50ä»£</option><option>60ä»£ä»¥ä¸Š</option>
  </select>

  <label>æ€§åˆ¥</label>
  <select id="f_gender">
    <option value="">é¸æŠ</option>
    <option>ç”·æ€§</option><option>å¥³æ€§</option><option>ä¸æ˜</option>
  </select>

  <label class="section-label">Build a connectionï¼ˆé–¢ä¿‚æ§‹ç¯‰ï¼‰</label>
  <textarea id="f_conn"></textarea>
  <div id="score_conn" class="score"></div>

  <label class="section-label">Curate & Proposeï¼ˆææ¡ˆï¼‰</label>
  <textarea id="f_prop"></textarea>
  <div id="score_prop" class="score"></div>

  <label class="section-label">Close the Saleï¼ˆã‚¯ãƒ­ãƒ¼ã‚¸ãƒ³ã‚°ï¼‰</label>
  <textarea id="f_close"></textarea>
  <div id="score_close" class="score"></div>

  <button id="saveBtn">ä¿å­˜</button>
</section>

<section class="panel">
  <h3>åˆ†æï¼ˆæœˆã”ã¨ï¼‰</h3>
  <div style="display: flex; gap: 8px; margin-bottom: 6px;">
    <select id="q_year" style="width: auto; flex: 1;"><option value="">å¹´ã‚’é¸æŠ</option></select>
    <select id="q_month_select" style="width: auto; flex: 1;"><option value="">æœˆã‚’é¸æŠ</option></select>
  </div>
  <button id="analyzeBtn">åˆ†æã™ã‚‹</button>
  <div id="analysis"></div>

  <h3>ãƒ­ã‚°ï¼ˆæœˆã”ã¨ï¼‰</h3>
  <div id="log"></div>
</section>
</main>

<script>
// ===== ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆå®šç¾© =====
const CHECKS={
  conn:[
    {id:1,text:'ã‚®ãƒ•ãƒˆã‚„ç”¨é€”ãªã©ã€ãŠå®¢æ§˜ã®ç›®çš„ã‚’è³ªå•ã§ããŸã‹',kw:['ã‚®ãƒ•ãƒˆ','ç”¨é€”','ç›®çš„']},
    {id:2,text:'ãƒ‹ãƒ¼ã‚ºã‚’å¼•ãå‡ºã™ã‚ªãƒ¼ãƒ—ãƒ³ã‚¯ã‚¨ã‚¹ãƒãƒ§ãƒ³ã‚’ä½¿ãˆãŸã‹',kw:['ã‚ªãƒ¼ãƒ—ãƒ³','è³ªå•','ãªãœ']},
    {id:3,text:'ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«æƒ…å ±ã‚’ä¼šè©±ã‚„å•†å“ç´¹ä»‹ã«æ´»ã‹ã›ãŸã‹',kw:['è¶£å‘³','ä¼šè©±','é›‘è«‡']},
    {id:4,text:'é–¢å¿ƒã‚„å…±æ„Ÿã‚’ç¤ºã—ã€ç©æ¥µçš„ã«å¯¾å¿œã§ããŸã‹',kw:['é–¢å¿ƒ','å…±æ„Ÿ','å¯„ã‚Šæ·»ã†','æ°—æŒã¡']},
    {id:5,text:'ãƒ–ãƒ©ãƒ³ãƒ‰ã®æ­´å²ã‚„ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚’å…±æœ‰ã§ããŸã‹',kw:['ãƒ–ãƒ©ãƒ³ãƒ‰ã‚¹ãƒˆãƒ¼ãƒªãƒ¼','ç‰©èª','ä¼çµ±','æ­´å²']}
  ],
  prop:[
    {id:1,text:'ä»£æ›¿æ¡ˆã‚„ã‚¹ã‚¿ã‚¤ãƒ«ã®å¹…ã‚’ææ¡ˆã§ããŸã‹',kw:['ä»£æ›¿','åˆ¥æ¡ˆ','ã‚¹ã‚¿ã‚¤ãƒ«']},
    {id:2,text:'å•†å“ã‚’æ•´ã£ãŸçŠ¶æ…‹ã§ç´¹ä»‹ã§ããŸã‹ï¼ˆãƒãƒƒã‚°ãƒ»RTWãƒ»é´ãªã©ï¼‰',kw:['æ•´ãˆ','ç¶ºéº—ã«','çŠ¶æ…‹']},
    {id:3,text:'ä¾¡æ ¼ä»¥å¤–ã®ä¾¡å€¤ã‚„ç†ç”±ã‚’èª¬æ˜ã§ããŸã‹',kw:['ä¾¡å€¤','ç†ç”±','ç´ æ','æ©Ÿèƒ½']},
    {id:4,text:'è©¦ç€ã‚’ä¿ƒã—ã€æ¡ˆå†…ã¨æ„è¦‹ç¢ºèªãŒã§ããŸã‹',kw:['è©¦ç€','å±¥ã„ã¦','ç€ã‘ã¦','è©¦ã•ã‚Œ']},
    {id:5,text:'ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ»ä¿è¨¼ãƒ»ã‚¢ãƒ•ã‚¿ãƒ¼ã‚µãƒ¼ãƒ“ã‚¹ã‚’å…±æœ‰ã§ããŸã‹',kw:['ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹','ä¿è¨¼','ä¿®ç†','ã‚¢ãƒ•ã‚¿ãƒ¼ã‚µãƒ¼ãƒ“ã‚¹','ãŠç£¨ã']},
    {id:6,text:'ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ã•ã‚’æ„Ÿã˜ã•ã›ã‚‰ã‚ŒãŸã‹',kw:['ãƒ—ãƒ­','çŸ¥è­˜','ä¸å¯§']},
    {id:7,text:'è¿½åŠ ã‚¢ã‚¤ãƒ†ãƒ ã‚„ã‚µãƒ¼ãƒ“ã‚¹ã‚’ææ¡ˆã§ããŸã‹',kw:['è¿½åŠ ','ã‚‚ã†ä¸€ç‚¹','ã‚µãƒ¼ãƒ“ã‚¹','ä»–']}
  ],
  close:[
    {id:1,text:'èãå‡ºã—ãŸæƒ…å ±ã‚’æ´»ã‹ã—ã¦ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ³ã‚°ã§ããŸã‹',kw:['æ±ºã‚ã‚‹','ãŠã™ã™ã‚','æœ¬æ—¥','ã§ã—ãŸã‚‰']},
    {id:2,text:'ç«¶åˆã‚„ä¾¡æ ¼ã®æ‡¸å¿µã«å¯¾å¿œã§ããŸã‹',kw:['ç«¶åˆ','æ¯”è¼ƒ','ä»–ãƒ–ãƒ©ãƒ³ãƒ‰','ä¾¡æ ¼','å€¤æ®µ','äºˆç®—']},
    {id:3,text:'è‡ªä¿¡ã‚’æŒã£ã¦è³¼å…¥ã‚’å‹§ã‚ã‚‰ã‚ŒãŸã‹',kw:['è‡ªä¿¡','ãœã²','é–“é•ã„ãªã„','ã´ã£ãŸã‚Š']},
    {id:4,text:'æœ€å¾Œã«è¦‹é€ã‚Šã¾ã§ä¸å¯§ã«å¯¾å¿œã§ããŸã‹',kw:['è¦‹é€ã‚Š','å‡ºå£','éšæ®µ','æœ€å¾Œã¾ã§']}
  ]
};

// === ã‚³ãƒ¡ãƒ³ãƒˆç²¾åº¦ã‚¢ãƒƒãƒ—ç”¨ã®è£œåŠ©é–¢æ•° ===

// ã‚¹ã‚³ã‚¢å¸¯ã”ã¨ã®è©•ä¾¡ãƒ©ãƒ™ãƒ«ã¨çŸ­è©•
function bandLabel(score){
  if(score < 40) return {label:'ã‹ãªã‚Šå¼±ã„', hint:'è³ªå•ãŒè¶³ã‚Šãšææ¡ˆã«ã¤ãªãŒã£ã¦ã„ãªã„'};
  if(score < 60) return {label:'å¼±ã‚', hint:'å¯¾å¿œã«ã°ã‚‰ã¤ããŒã‚ã‚Šå®‰å®šã—ã¦ã„ãªã„'};
  if(score < 80) return {label:'æ™®é€š', hint:'åŸºæœ¬ã¯ã§ãã¦ã„ã‚‹ãŒæ·±ã¿ã«æ¬ ã‘ã‚‹'};
  return {label:'å¼·ã¿', hint:'å®‰å®šã—ã¦ã„ã¦èª¬å¾—åŠ›ãŒã‚ã‚‹'};
}

// ã‚³ãƒ¡ãƒ³ãƒˆæ–‡ã®ä¸­ã‹ã‚‰ä¸è¶³ã—ã¦ã„ã‚‹è¦³ç‚¹ã‚’æ¤œå‡º
function coverageByCheck(all, groupKey){
  const textArr = all.map(l => (l.comments?.[groupKey] || ''));
  const checks = CHECKS[groupKey];
  const stats = checks.map(item=>{
    const hit = textArr.filter(tx => item.kw.some(k=>tx.includes(k))).length;
    const pct = textArr.length ? Math.round(hit / textArr.length * 100) : 0;
    return {id:item.id, text:item.text, pct, kw:item.kw};
  });
  return stats.sort((a,b)=>a.pct-b.pct).slice(0,2); // å‡ºç¾ç‡ã®ä½ã„2ä»¶ã‚’è¿”ã™
}

// è¸ã¿è¾¼ã‚“ã ã‚³ãƒ¡ãƒ³ãƒˆç”Ÿæˆ
function buildComments(all, cAvg, rate, cnt){
  const comments = [];
  if(cnt < 8) comments.push(`â€» ã‚µãƒ³ãƒ—ãƒ«å°‘ï¼ˆ${cnt}ä»¶ï¼‰ã€‚å‚¾å‘ã¯æš«å®š`);

  // Build / Propose / Close ãã‚Œãã‚Œã®çŸ­è©•
  ([
    ['Buildï¼ˆãƒ’ã‚¢ãƒªãƒ³ã‚°/é–¢ä¿‚æ§‹ç¯‰ï¼‰','conn'],
    ['Proposeï¼ˆææ¡ˆï¼‰','prop'],
    ['Closeï¼ˆã‚¯ãƒ­ãƒ¼ã‚¸ãƒ³ã‚°ï¼‰','close'],
  ]).forEach(([label,key])=>{
    const band = bandLabel(cAvg[key]);
    comments.push(`${label}ï¼š${cAvg[key]}% â†’ ${band.label}ï¼ˆ${band.hint}ï¼‰`);
  });

  // ãƒ•ã‚§ãƒ¼ã‚ºé–“ã®ãƒœãƒˆãƒ«ãƒãƒƒã‚¯æ¤œå‡º
  const gap = (a,b)=>Math.abs(a-b);
  if(cAvg.conn >= 70 && cAvg.prop < 60){
    comments.push('ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ï¼šãƒ’ã‚¢ãƒªãƒ³ã‚°ã‹ã‚‰ææ¡ˆã¸ã®æ©‹æ¸¡ã—ãŒå¼±ã„');
  }
  if(cAvg.prop >= 70 && cAvg.close < 60){
    comments.push('ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ï¼šææ¡ˆã‹ã‚‰ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ³ã‚°ã¸ã®ã¤ãªããŒå¼±ã„');
  }
  if(cAvg.conn < 60 && (cAvg.prop >= 70 || cAvg.close >= 70)){
    comments.push('åºç›¤ã®æ·±æ˜ã‚Šä¸è¶³ãŒå¾ŒåŠã«å½±éŸ¿ã—ã¦ã„ã‚‹');
  }
  if(gap(cAvg.conn, cAvg.prop) >= 15){
    comments.push('Build ã¨ Propose ã®å·®ãŒå¤§ãã„');
  }

  // æˆç´„ç‡ã¨ Close ã®æ•´åˆãƒã‚§ãƒƒã‚¯
  if(cAvg.close >= 75 && rate < 35){
    comments.push('Close ã¯é«˜ã„ã®ã«æˆç´„ç‡ãŒä½ã„ â†’ æµå…¥è³ªã‚„åœ¨åº«ã®é©åˆã«èª²é¡Œ');
  } else if(cAvg.close < 60 && rate >= 35){
    comments.push('æˆç´„ç‡ã¯è‰¯ã„ãŒ Close ãŒä½ã„ â†’ çµ‚ç›¤å¯¾å¿œã®å†ç¾æ€§ãŒä¸è¶³');
  }

  // ã‚³ãƒ¡ãƒ³ãƒˆå†…ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ä¸è¶³ã‚’æ¤œå‡º
  const lowConn = coverageByCheck(all, 'conn');
  const lowProp = coverageByCheck(all, 'prop');
  const lowClose = coverageByCheck(all, 'close');

  if(lowConn.length){
    const tips = lowConn.map(s=>`ãƒ»${s.text}ï¼ˆè¨€åŠç‡${s.pct}%ï½œKW:${s.kw.join('ãƒ»')}ï¼‰`).join('<br>');
    comments.push(`ã€Buildã®å¼±ç‚¹ã€‘<br>${tips}`);
  }
  if(lowProp.length){
    const tips = lowProp.map(s=>`ãƒ»${s.text}ï¼ˆè¨€åŠç‡${s.pct}%ï½œKW:${s.kw.join('ãƒ»')}ï¼‰`).join('<br>');
    comments.push(`ã€Proposeã®å¼±ç‚¹ã€‘<br>${tips}`);
  }
  if(lowClose.length){
    const tips = lowClose.map(s=>`ãƒ»${s.text}ï¼ˆè¨€åŠç‡${s.pct}%ï½œKW:${s.kw.join('ãƒ»')}ï¼‰`).join('<br>');
    comments.push(`ã€Closeã®å¼±ç‚¹ã€‘<br>${tips}`);
  }

  return comments;
}

// === ã‚³ãƒ¡ãƒ³ãƒˆç²¾åº¦ã‚¢ãƒƒãƒ—ç”¨ã®è£œåŠ©é–¢æ•° ===
function bandLabel(score){
  if(score < 40) return {label:'è¦æ”¹å–„ï¼ˆæ·±åˆ»ï¼‰', hint:'è³ªå•ãŒè¶³ã‚Šãšææ¡ˆã«ã¤ãªãŒã£ã¦ã„ãªã„'};
  if(score < 60) return {label:'å¼±ã‚', hint:'å¯¾å¿œã«ã°ã‚‰ã¤ããŒã‚ã‚Šå®‰å®šã—ã¦ã„ãªã„'};
  if(score < 80) return {label:'æ¨™æº–', hint:'åŸºæœ¬ã¯ã§ãã¦ã„ã‚‹ãŒæ·±ã¿ã«æ¬ ã‘ã‚‹'};
  return {label:'å¼·ã¿', hint:'å®‰å®šã—ã¦ã„ã¦èª¬å¾—åŠ›ãŒã‚ã‚‹'};
}

function coverageByCheck(all, groupKey){
  const textArr = all.map(l => (l.comments?.[groupKey] || ''));
  const checks = CHECKS[groupKey];
  const stats = checks.map(item=>{
    const hit = textArr.filter(tx => item.kw.some(k=>tx.includes(k))).length;
    const pct = textArr.length ? Math.round(hit / textArr.length * 100) : 0;
    return {id:item.id, text:item.text, pct, kw:item.kw};
  });
  return stats.sort((a,b)=>a.pct-b.pct).slice(0,2);
}

function buildComments(all, cAvg, rate, cnt){
  const comments = [];
  if(cnt < 8){
    comments.push(`â€» ä»Šæœˆã®ã‚µãƒ³ãƒ—ãƒ«æ•°ãŒå°‘ãªã„ãŸã‚æš«å®šã§ã™ï¼ˆ${cnt}ä»¶ï¼‰ã€‚`);
  }
  ([
    ['Buildï¼ˆãƒ’ã‚¢ãƒªãƒ³ã‚°/é–¢ä¿‚æ§‹ç¯‰ï¼‰','conn'],
    ['Proposeï¼ˆææ¡ˆï¼‰','prop'],
    ['Closeï¼ˆã‚¯ãƒ­ãƒ¼ã‚¸ãƒ³ã‚°ï¼‰','close'],
  ]).forEach(([label,key])=>{
    const band = bandLabel(cAvg[key]);
    comments.push(`${label}ï¼š${cAvg[key]}% â†’ ${band.label}ã€‚${band.hint}`);
  });
  // ä»¥é™ã€ãƒœãƒˆãƒ«ãƒãƒƒã‚¯æ¤œå‡ºã‚„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ä¸è¶³ã®æŒ‡æ‘˜â€¦ï¼ˆå‰ã®å›ç­”ã®ã‚³ãƒ¼ãƒ‰ãã®ã¾ã¾ï¼‰
  return comments;
}


let state={conn:{},prop:{},close:{}};
let logs=JSON.parse(localStorage.getItem('pdca_logs')||'{}'); // æ—¥ä»˜ã”ã¨

function toggleState(group,id){
  let cur=state[group][id]||'âŒ';
  let next= cur==='âŒ' ? 'â­•ï¸' : (cur==='â­•ï¸'?'ï¼':'âŒ');
  state[group][id]=next; updateScores();
}
function autoJudge(text,list,group){
  list.forEach(item=>{
    let hit=item.kw.some(k=>text.includes(k));
    if(!state[group][item.id]) state[group][item.id]=hit?'â­•ï¸':'âŒ';
  });
}
function calcScore(group,list){
  let res=list.map(item=>({t:item.text,s:state[group][item.id]||'âŒ'}));
  let ok=res.filter(r=>r.s==='â­•ï¸').length;
  let bad=res.filter(r=>r.s==='âŒ').length;
  let total=ok+bad;
  let pct= total>0?Math.round(ok/total*100):0;
  return {res,ok,total,pct};
}
function renderScore(group,list,containerId){
  let {res,ok,total,pct}=calcScore(group,list);
  let html=`<b>${ok} / ${total}ï¼ˆ${pct}%ï¼‰</b><div class="details">`;
  res.forEach((r,i)=>{
    let cls=r.s==='â­•ï¸'?'ok':(r.s==='âŒ'?'bad':'na');
    html+=`<div class="item-row"><span class="state ${cls}" onclick="toggleState('${group}',${i+1})">${r.s}</span> ${r.t}</div>`;
  });
  html+='</div>'; document.getElementById(containerId).innerHTML=html;
}
function updateScores(){
  autoJudge(f_conn.value,CHECKS.conn,'conn');
  autoJudge(f_prop.value,CHECKS.prop,'prop');
  autoJudge(f_close.value,CHECKS.close,'close');
  renderScore('conn',CHECKS.conn,'score_conn');
  renderScore('prop',CHECKS.prop,'score_prop');
  renderScore('close',CHECKS.close,'score_close');
}
['f_conn','f_prop','f_close'].forEach(id=>document.getElementById(id).addEventListener('input',updateScores));

function resetForm(){
  f_date.value='';
  f_result.value='';
  f_purpose.value='';
  f_category.value='';
  f_price.value='';
  f_age.value='';
  f_gender.value='';
  f_conn.value='';
  f_prop.value='';
  f_close.value='';
  state={conn:{},prop:{},close:{}};
  updateScores();
}

function populateDateSelectors() {
  const years = [...new Set(Object.keys(logs).map(d => d.substring(0, 4)))].sort().reverse();
  q_year.innerHTML = '<option value="">å¹´ã‚’é¸æŠ</option>' + years.map(y => `<option value="${y}">${y}å¹´</option>`).join('');

  let monthHtml = '<option value="">æœˆã‚’é¸æŠ</option>';
  for (let i = 1; i <= 12; i++) {
    monthHtml += `<option value="${i}">${i}æœˆ</option>`;
  }
  q_month_select.innerHTML = monthHtml;
}

saveBtn.onclick=()=>{
  if(!f_date.value){alert("æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return;}
  let scores={
    conn:calcScore('conn',CHECKS.conn).pct,
    prop:calcScore('prop',CHECKS.prop).pct,
    close:calcScore('close',CHECKS.close).pct
  };
  let entry={
    result:f_result.value,
    purpose:f_purpose.value,
    category:f_category.value,
    price:f_price.value,
    age:f_age.value,
    gender:f_gender.value,
    comments:{conn:f_conn.value,prop:f_prop.value,close:f_close.value},
    scores
  };
  if(!logs[f_date.value]) logs[f_date.value]=[];
  logs[f_date.value].push(entry);
  localStorage.setItem('pdca_logs',JSON.stringify(logs));
  renderLogs();
  populateDateSelectors();
  alert('ä¿å­˜ã—ã¾ã—ãŸã€‚');
  resetForm();
};

function showComments(date, index) {
  const entry = logs[date] && logs[date][index];
  if (!entry) {
    alert('ã‚³ãƒ¡ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
    return;
  }
  const c = entry.comments;
  const text = `ã€é–¢ä¿‚æ§‹ç¯‰ã€‘\n${c.conn}\n\nã€ææ¡ˆã€‘\n${c.prop}\n\nã€ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ³ã‚°ã€‘\n${c.close}`;
  alert(text);
}

function deleteLog(date, index, event) {
  event.stopPropagation(); // Prevent the comment popup from opening
  if (confirm('ã“ã®ãƒ­ã‚°ã‚’æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
    // Remove the specific entry
    logs[date].splice(index, 1);

    // If the date has no more entries, remove the date itself
    if (logs[date].length === 0) {
      delete logs[date];
    }

    // Save the updated logs
    localStorage.setItem('pdca_logs', JSON.stringify(logs));

    // Re-render the UI
    renderLogs();
    populateDateSelectors(); // Update year/month dropdowns in case a year was removed
  }
}

function updateProspect(date, index, event) {
  event.stopPropagation();
  const entry = logs[date][index];
  
  if (confirm(`ã“ã®ãƒ—ãƒ­ã‚¹ãƒšã‚¯ãƒˆã‚’ã€Œè³¼å…¥ã€ã«å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ`)) {
    entry.result = 'è³¼å…¥';
  } else if (confirm(`ã€Œè³¼å…¥ãªã—ã€ã«å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ`)) {
    entry.result = 'è³¼å…¥ãªã—';
  } else {
    return; // User cancelled both, do nothing
  }
  
  localStorage.setItem('pdca_logs', JSON.stringify(logs));
  renderLogs();
}

function renderLogs(){
  // 1. Group logs by month
  const logsByMonth = {};
  const sortedDates = Object.keys(logs).sort().reverse(); // Newest dates first

  for (const date of sortedDates) {
    const month = date.substring(0, 7); // "YYYY-MM"
    if (!logsByMonth[month]) {
      logsByMonth[month] = {};
    }
    logsByMonth[month][date] = logs[date];
  }

  // 2. Render the HTML
  const sortedMonths = Object.keys(logsByMonth).sort().reverse(); // Newest months first

  log.innerHTML = sortedMonths.map(month => {
    const monthDates = Object.keys(logsByMonth[month]);
    
    // Create the content for inside the collapsible section
    const monthContent = monthDates.map(date => {
      const items = logsByMonth[month][date].map((l, i) => {
        let resultHtml;
        if (l.result === 'ãƒ—ãƒ­ã‚¹ãƒšã‚¯ãƒˆ') {
          resultHtml = `<b style="cursor:pointer; color:#c69500; text-decoration:underline;" onclick="updateProspect('${date}', ${i}, event)">${l.result}</b>`;
        } else {
          resultHtml = `<b>${l.result}</b>`;
        }

        return `<div style="display:flex; align-items:center; border:1px solid #ddd;margin:4px;padding:4px;">
                  <div style="flex-grow:1; cursor:pointer;" onclick="showComments('${date}', ${i})">
                    <div>${resultHtml} (${l.purpose}/${l.category}/${l.price}/${l.age}/${l.gender})</div>
                    <div>Build:${l.scores.conn}% / Propose:${l.scores.prop}% / Close:${l.scores.close}%</div>
                  </div>
                  <span onclick="deleteLog('${date}', ${i}, event)" style="cursor:pointer; padding: 0 4px; font-size:0.7rem;">ğŸ—‘ï¸</span>
                </div>`;
      }).join('');
      return `<h4>${date}</h4>${items}`;
    }).join('');

    // Format month string for display, e.g., "2023-09" -> "2023å¹´9æœˆ"
    const [year, monthNum] = month.split('-');
    const displayMonth = `${year}å¹´${parseInt(monthNum, 10)}æœˆ`;

    // Use <details> and <summary> for the collapsible section
    return `<details>
              <summary style="cursor:pointer; font-size:1.1rem; font-weight:bold; margin: 8px 0;">${displayMonth}</summary>
              ${monthContent}
            </details>`;
  }).join('');
}

analyzeBtn.onclick=()=>{
  const year = q_year.value;
  const monthVal = q_month_select.value;
  if(!year || !monthVal){analysis.innerHTML="å¹´ã¨æœˆã‚’é¸æŠã—ã¦ãã ã•ã„"; return;}

  const month = `${year}-${monthVal.padStart(2, '0')}`;
  let all=[];
  Object.keys(logs).forEach(d=>{
    if(d.startsWith(month)) all.push(...logs[d]);
  });
  let cnt=all.length;
  let buy=all.filter(l=>l.result==="è³¼å…¥").length;
  let rate=cnt>0?Math.round(buy/cnt*100):0;

  let avg=(key)=>cnt?Math.round(all.map(l=>l.scores[key]||0).reduce((a,b)=>a+b,0)/cnt):0;
  let cAvg={conn:avg('conn'),prop:avg('prop'),close:avg('close')};

  // â† ã“ã“ãŒæ–°ãƒã‚¤ãƒ³ãƒˆ
  const comments = buildComments(all, cAvg, rate, cnt);

  analysis.innerHTML = `
    <table>
      <tr><th>ä»¶æ•°</th><th>è³¼å…¥</th><th>è³¼å…¥ç‡</th></tr>
      <tr><td>${cnt}</td><td>${buy}</td><td>${rate}%</td></tr>
    </table>
    <table>
      <tr><th>Build å¹³å‡</th><th>Propose å¹³å‡</th><th>Close å¹³å‡</th></tr>
      <tr><td>${cAvg.conn}%</td><td>${cAvg.prop}%</td><td>${cAvg.close}%</td></tr>
    </table>
    <p><b>æ”¹å–„ã‚³ãƒ¡ãƒ³ãƒˆ:</b><br>${comments.join("<br>")}</p>
  `;
};

renderLogs();
updateScores();
populateDateSelectors();
</script>
</body>
</html>